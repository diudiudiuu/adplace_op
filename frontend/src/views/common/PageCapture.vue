<template>
    <div class="page-capture-container">
        <!-- È°µÈù¢Ê†áÈ¢ò -->
        <n-card class="header-card">
            <template #header>
                <div class="header-content">
                    <n-icon size="24" color="#2080f0">
                        <CameraOutline />
                    </n-icon>
                    <span class="header-title">ÁΩëÈ°µÂ§á‰ªΩÂ∑•ÂÖ∑</span>
                </div>
            </template>
            <n-text depth="3">ÂÆåÊï¥Â§á‰ªΩÁΩëÈ°µÂÜÖÂÆπÔºåÂåÖÊã¨HTML„ÄÅCSS„ÄÅJavaScript„ÄÅÂõæÁâáÁ≠âÊâÄÊúâËµÑÊ∫êÔºåÊîØÊåÅÈöêÁßÅÊ∏ÖÁêÜÂäüËÉΩ</n-text>
        </n-card>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
        <div class="main-content">
            <!-- Â∑¶‰æßÈÖçÁΩÆÂå∫Âüü -->
            <div class="config-section">
                <n-card title="üìù Â§á‰ªΩÈÖçÁΩÆ" size="small">
                    <n-form :model="form" label-placement="top">
                        <n-form-item label="ÁõÆÊ†áÁΩëÂùÄ" required>
                            <n-input 
                                v-model:value="form.url" 
                                placeholder="ËØ∑ËæìÂÖ•Ë¶ÅÂ§á‰ªΩÁöÑÁΩëÈ°µ URLÔºåÂ¶ÇÔºöhttps://example.com"
                                size="large"
                                @keyup.enter="captureUrl"
                            >
                                <template #suffix>
                                    <n-button text type="primary" @click="testConnection" :disabled="!form.url.trim()">
                                        ÊµãËØï
                                    </n-button>
                                </template>
                            </n-input>
                        </n-form-item>
                        
                        <n-form-item label="‰øùÂ≠òÁõÆÂΩï" required>
                            <n-input 
                                v-model:value="saveDirectory" 
                                placeholder="ËØ∑ÈÄâÊã©‰øùÂ≠òÂ§á‰ªΩÊñá‰ª∂ÁöÑÁõÆÂΩï" 
                                readonly
                                size="large"
                            >
                                <template #suffix>
                                    <n-button text type="primary" @click="selectDirectory">
                                        ÈÄâÊã©ÁõÆÂΩï
                                    </n-button>
                                </template>
                            </n-input>
                        </n-form-item>
                        <!-- Âø´ÈÄüÈÖçÁΩÆ -->
                        <n-form-item label="Â§á‰ªΩÂÜÖÂÆπ">
                            <n-checkbox-group v-model:value="quickOptions">
                                <n-space>
                                    <n-checkbox value="images" label="ÂõæÁâá" />
                                    <n-checkbox value="styles" label="Ê†∑Âºè" />
                                    <n-checkbox value="scripts" label="ËÑöÊú¨" />
                                    <n-checkbox value="videos" label="ËßÜÈ¢ë" />
                                </n-space>
                            </n-checkbox-group>
                        </n-form-item>
                        
                        <n-form-item label="ÈöêÁßÅÊ∏ÖÁêÜ">
                            <n-checkbox-group v-model:value="privacyOptions">
                                <n-space>
                                    <n-checkbox value="analytics" label="ÁªüËÆ°‰ª£Á†Å" />
                                    <n-checkbox value="tracking" label="Ë∑üË∏™‰ª£Á†Å" />
                                    <n-checkbox value="ads" label="ÂπøÂëä‰ª£Á†Å" />
                                </n-space>
                            </n-checkbox-group>
                        </n-form-item>
                        
                        <!-- È´òÁ∫ßÈÄâÈ°πÊäòÂè† -->
                        <n-collapse>
                            <n-collapse-item title="È´òÁ∫ßÈÄâÈ°π" name="advanced">
                                <n-space vertical size="small">
                                    <n-form-item label="Ë∂ÖÊó∂Êó∂Èó¥">
                                        <n-input-number v-model:value="options.timeout" :min="60" :max="300" :step="10" size="small" />
                                        <template #suffix>Áßí</template>
                                    </n-form-item>
                                    <n-form-item label="ÊúÄÂ§ßÊñá‰ª∂Êï∞">
                                        <n-input-number v-model:value="options.maxFiles" :min="200" :max="1000" :step="50" size="small" />
                                        <template #suffix>‰∏™</template>
                                    </n-form-item>
                                    <n-form-item label="Âπ∂ÂèëÊï∞">
                                        <n-input-number v-model:value="options.maxConcurrency" :min="1" :max="20" :step="1" size="small" />
                                        <template #suffix">‰∏™</template>
                                    </n-form-item>
                                </n-space>
                            </n-collapse-item>
                        </n-collapse>
                    </n-form>
                    
                    <!-- Â§á‰ªΩÊåâÈíÆ -->
                    <n-divider />
                    <div class="action-buttons">
                        <n-button 
                            type="primary" 
                            size="large" 
                            block
                            @click="captureUrl" 
                            :disabled="!form.url.trim() || !saveDirectory.trim() || isCapturing"
                            :loading="isCapturing"
                        >
                            <template #icon>
                                <n-icon>
                                    <CameraOutline />
                                </n-icon>
                            </template>
                            {{ isCapturing ? 'Â§á‰ªΩ‰∏≠...' : 'ÂºÄÂßãÂ§á‰ªΩ' }}
                        </n-button>
                        
                        <n-space justify="space-between" style="margin-top: 12px;">
                            <n-button size="small" @click="clearResults" :disabled="isCapturing">
                                <template #icon>
                                    <n-icon>
                                        <RefreshOutline />
                                    </n-icon>
                                </template>
                                Ê∏ÖÁ©∫ÁªìÊûú
                            </n-button>
                            <n-button size="small" @click="showDocumentation">
                                <template #icon>
                                    <n-icon>
                                        <DocumentTextOutline />
                                    </n-icon>
                                </template>
                                ÂäüËÉΩËØ¥Êòé
                            </n-button>
                        </n-space>
                    </div>
                </n-card>
            </div>

            <!-- Âè≥‰æßËøõÂ∫¶ÂíåÁªìÊûúÂå∫Âüü -->
            <div class="progress-section">
                <!-- Á©∫Áä∂ÊÄÅ -->
                <n-card v-if="!isCapturing && !captureResult" class="status-card empty">
                    <div class="empty-state">
                        <n-icon size="48" color="#d0d0d0">
                            <CameraOutline />
                        </n-icon>
                        <n-text depth="3">ËØ∑ÈÖçÁΩÆÂ§á‰ªΩÂèÇÊï∞Âπ∂ÁÇπÂáª"ÂºÄÂßãÂ§á‰ªΩ"</n-text>
                    </div>
                </n-card>

                <!-- Â§á‰ªΩËøõÂ∫¶ -->
                <n-card v-if="isCapturing" class="status-card progress" title="üöÄ Â§á‰ªΩËøõË°å‰∏≠">
                    <template #header-extra>
                        <n-tag type="info">{{ captureProgress.phase === 'analyzing' ? 'ÂàÜÊûê‰∏≠' : captureProgress.phase === 'downloading' ? '‰∏ãËΩΩ‰∏≠' : '‰øùÂ≠ò‰∏≠' }}</n-tag>
                    </template>
                    
                    <n-space vertical size="large">
                        <!-- ÊÄª‰ΩìËøõÂ∫¶ -->
                        <div class="overall-progress">
                            <div class="progress-info">
                                <span class="progress-label">{{ getPhaseText(captureProgress.phase) }}</span>
                                <span class="progress-count">{{ captureProgress.completedFiles }}/{{ captureProgress.totalFiles }}</span>
                            </div>
                            <n-progress 
                                type="line" 
                                :percentage="Math.round((captureProgress.completedFiles / Math.max(captureProgress.totalFiles, 1)) * 100)"
                                :show-indicator="false"
                                :height="12"
                                border-radius="6px"
                                :color="captureProgress.phase === 'complete' ? '#18a058' : '#2080f0'"
                            />
                            <n-text v-if="captureProgress.currentFile" depth="3" style="font-size: 12px; margin-top: 8px;">
                                {{ captureProgress.currentFile }}
                            </n-text>
                        </div>

                        <!-- Êñá‰ª∂ÂàóË°® -->
                        <div v-if="captureProgress.fileList.length > 0" class="file-list-section">
                            <n-divider title-placement="left">
                                <n-text strong>Êñá‰ª∂‰∏ãËΩΩËØ¶ÊÉÖ ({{ captureProgress.fileList.length }})</n-text>
                            </n-divider>
                            
                            <n-data-table
                                :columns="fileTableColumns"
                                :data="captureProgress.fileList"
                                :pagination="false"
                                :max-height="120"
                                size="small"
                                striped
                                :row-props="() => ({ style: 'height: 32px;' })"
                            />
                        </div>
                    </n-space>
                </n-card>

                <!-- Â§á‰ªΩÁªìÊûú -->
                <n-card v-if="captureResult && !isCapturing" class="status-card result" :title="captureResult.success ? '‚úÖ Â§á‰ªΩÂÆåÊàê' : '‚ùå Â§á‰ªΩÂ§±Ë¥•'">
                    <template #header-extra>
                        <n-tag :type="captureResult.success ? 'success' : 'error'">
                            {{ captureResult.success ? 'ÊàêÂäü' : 'Â§±Ë¥•' }}
                        </n-tag>
                    </template>

                    <n-space vertical>
                        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                        <n-descriptions :column="2" bordered size="small">
                            <n-descriptions-item label="ÁΩëÂùÄ">
                                <n-tooltip trigger="hover" placement="top">
                                    <template #trigger>
                                        <n-text class="url-text">{{ captureResult.url }}</n-text>
                                    </template>
                                    {{ captureResult.url }}
                                </n-tooltip>
                            </n-descriptions-item>
                            <n-descriptions-item label="Áä∂ÊÄÅÁ†Å">
                                <n-tag :type="captureResult.statusCode === 200 ? 'success' : 'warning'">
                                    {{ captureResult.statusCode }}
                                </n-tag>
                            </n-descriptions-item>
                            <n-descriptions-item label="Êñá‰ª∂Êï∞Èáè">
                                <n-text>{{ captureResult.filesCount }} ‰∏™</n-text>
                            </n-descriptions-item>
                            <n-descriptions-item label="ZIPÂ§ßÂ∞è">
                                <n-text>{{ formatBytes(captureResult.zipSize || 0) }}</n-text>
                            </n-descriptions-item>
                        </n-descriptions>

                        <!-- Êñá‰ª∂ÁªüËÆ° -->
                        <div v-if="captureProgress.fileList.length > 0" class="file-statistics">
                            <n-space>
                                <n-tag type="success">ÊàêÂäü: {{ getFileStats().completed }}</n-tag>
                                <n-tag v-if="getFileStats().failed > 0" type="error">Â§±Ë¥•: {{ getFileStats().failed }}</n-tag>
                                <n-tag type="info">ÊÄªËÆ°: {{ captureProgress.fileList.length }}</n-tag>
                            </n-space>
                        </div>

                        <!-- ‰øùÂ≠òÁä∂ÊÄÅ -->
                        <n-alert v-if="captureResult.success" type="success" title="Â§á‰ªΩÊñá‰ª∂Â∑≤‰øùÂ≠ò">
                            <n-text>ÂÆåÊï¥ÁöÑÁΩëÈ°µÂ∑≤Â§á‰ªΩÂπ∂‰øùÂ≠òÂà∞Ôºö{{ saveDirectory }}</n-text>
                        </n-alert>

                        <!-- Êñá‰ª∂ÂàóË°® (ÁªìÊûúÈ°µÈù¢‰πüÊòæÁ§∫) -->
                        <div v-if="captureProgress.fileList.length > 0" class="file-list-section">
                            <n-divider title-placement="left">
                                <n-text strong>Êñá‰ª∂‰∏ãËΩΩËØ¶ÊÉÖ ({{ captureProgress.fileList.length }})</n-text>
                            </n-divider>
                            
                            <n-data-table
                                :columns="fileTableColumns"
                                :data="captureProgress.fileList"
                                :pagination="false"
                                :max-height="120"
                                size="small"
                                striped
                                :row-props="() => ({ style: 'height: 32px;' })"
                            />
                        </div>
                    </n-space>
                </n-card>
            </div>
        </div>







        <!-- ÂäüËÉΩËØ¥ÊòéÂºπÁ™ó -->
        <n-modal v-model:show="showDocModal" preset="card" title="üìñ È°µÈù¢ÊçïËé∑ÈöêÁßÅÊ∏ÖÁêÜÂäüËÉΩËØ¥Êòé" style="width: 90%; max-width: 1000px;">
            <div v-html="documentationContent" class="documentation-content"></div>
        </n-modal>

        <!-- ÊµãËØïÈ°µÈù¢ÂºπÁ™ó -->
        <n-modal v-model:show="showTestModal" preset="card" title="üß™ ÊµãËØïÈ°µÈù¢‰ª£Á†Å" style="width: 90%; max-width: 1000px;">
            <n-code :code="testPageContent" language="html" show-line-numbers />
        </n-modal>
    </div>
</template>

<script setup lang="ts">
import { ref, inject, onMounted, onUnmounted, h, watch } from 'vue'
import { useMessage } from 'naive-ui'
import { 
    RefreshOutline, 
    ArchiveOutline, 
    DocumentTextOutline, 
    CodeOutline,
    CheckmarkCircle,
    CloseCircle,
    TimeOutline,
    DocumentOutline,
    ImageOutline,
    VideocamOutline,
    MusicalNotesOutline,
    CodeSlashOutline,
    ColorPaletteOutline,
    ChevronUpOutline,
    ChevronDownOutline,
    CameraOutline
} from '@vicons/ionicons5'
import api from '@/api'

const message = useMessage()

// Ê≥®ÂÖ•ÂÖ®Â±Ä loading
const globalLoading = inject('globalLoading') as any

// Ë°®ÂçïÊï∞ÊçÆ
const form = ref({
    url: ''
})

// ÊäìÂèñÈÄâÈ°π
const options = ref({
    includeImages: true,
    includeStyles: true,
    includeScripts: true,
    followRedirects: true,
    includeFonts: true,
    includeVideos: true,
    removeAnalytics: true,
    removeTracking: true,
    removeAds: true,
    removeTagManager: true,
    removeMaliciousTags: true,
    timeout: 300,
    maxFiles: 200,
    maxDepth: 1,
    maxConcurrency: 10,
    forceEncoding: 'auto'
})

// ÊäìÂèñÁªìÊûúÂíåËøõÂ∫¶Áä∂ÊÄÅ
const captureResult = ref<any>(null)
const isCapturing = ref(false)
const captureProgress = ref({
    phase: '', // 'analyzing', 'downloading', 'saving', 'complete'
    totalFiles: 0,
    completedFiles: 0,
    currentFile: '',
    fileProgress: 0,
    downloadSpeed: '',
    estimatedTime: '',
    fileList: [] as Array<{
        name: string,
        type: string,
        size: string,
        status: 'pending' | 'downloading' | 'completed' | 'failed',
        progress: number,
        url: string
    }>
})

// ÂºπÁ™óÊéßÂà∂
const showDocModal = ref(false)
const showTestModal = ref(false)

// ÁïåÈù¢Áä∂ÊÄÅ
const quickOptions = ref(['images', 'styles', 'scripts'])
const privacyOptions = ref(['analytics', 'tracking'])

// ÂêåÊ≠•Âø´ÈÄüÈÄâÈ°πÂíåËØ¶ÁªÜÈÄâÈ°π
watch(quickOptions, (newVal) => {
    options.value.includeImages = newVal.includes('images')
    options.value.includeStyles = newVal.includes('styles')
    options.value.includeScripts = newVal.includes('scripts')
    options.value.includeVideos = newVal.includes('videos')
}, { immediate: true })

watch(privacyOptions, (newVal) => {
    options.value.removeAnalytics = newVal.includes('analytics')
    options.value.removeTracking = newVal.includes('tracking')
    options.value.removeAds = newVal.includes('ads')
}, { immediate: true })

// ÁºñÁ†ÅÈÄâÈ°π
const encodingOptions = [
    { label: 'Ëá™Âä®Ê£ÄÊµã', value: 'auto' },
    { label: 'UTF-8', value: 'utf-8' },
    { label: 'GBK/GB2312', value: 'gbk' },
    { label: 'Big5 (ÁπÅ‰Ωì‰∏≠Êñá)', value: 'big5' },
    { label: 'Shift_JIS (Êó•Êñá)', value: 'shift_jis' },
    { label: 'EUC-KR (Èü©Êñá)', value: 'euc-kr' },
    { label: 'ISO-8859-1', value: 'iso-8859-1' },
    { label: 'Windows-1252', value: 'windows-1252' }
]

// ÊñáÊ°£ÂÜÖÂÆπ
const documentationContent = ref('')
const testPageContent = ref('')



// ‰øùÂ≠òÁõÆÂΩïÔºà‰ªéÊú¨Âú∞ÁºìÂ≠òÂä†ËΩΩÔºâ
const saveDirectory = ref(localStorage.getItem('pageCapture_saveDirectory') || '')

// ËæÖÂä©ÊñπÊ≥ï
const getPhaseText = (phase: string) => {
    const phases: Record<string, string> = {
        'analyzing': 'üîç ÂàÜÊûêÈ°µÈù¢ÁªìÊûÑ',
        'downloading': '‚¨áÔ∏è ‰∏ãËΩΩËµÑÊ∫êÊñá‰ª∂',
        'saving': 'üíæ ‰øùÂ≠òÊñá‰ª∂',
        'complete': '‚úÖ Â§á‰ªΩÂÆåÊàê'
    }
    return phases[phase] || 'Â§ÑÁêÜ‰∏≠...'
}

const getFileIcon = (type: string) => {
    const icons: Record<string, any> = {
        'css': ColorPaletteOutline,
        'js': CodeSlashOutline,
        'images': ImageOutline,
        'videos': VideocamOutline,
        'fonts': MusicalNotesOutline,
        'html': DocumentOutline
    }
    return icons[type] || DocumentOutline
}

const getFileTypeColor = (type: string) => {
    const colors: Record<string, string> = {
        'css': 'info',
        'js': 'warning',
        'images': 'success',
        'videos': 'error',
        'fonts': 'default',
        'html': 'primary'
    }
    return colors[type] || 'default'
}

// ËÆ°ÁÆóÊñá‰ª∂ÁªüËÆ°
const getFileStats = () => {
    const stats = {
        completed: 0,
        failed: 0,
        downloading: 0,
        pending: 0
    }
    
    captureProgress.value.fileList.forEach(file => {
        if (file.status === 'completed') {
            stats.completed++
        } else if (file.status === 'failed') {
            stats.failed++
        } else if (file.status === 'downloading') {
            stats.downloading++
        } else {
            stats.pending++
        }
    })
    
    return stats
}

// Êñá‰ª∂Ë°®Ê†ºÂàóÈÖçÁΩÆ - ÁÆÄÂåñÁâà
const fileTableColumns = [
    {
        title: 'Êñá‰ª∂',
        key: 'name',
        ellipsis: true,
        render: (row: any) => {
            console.log('Ê∏≤ÊüìÊñá‰ª∂:', row.name, row.type)
            return h('div', { 
                class: 'file-name-cell',
                title: row.name,
                style: { display: 'flex', alignItems: 'center' }
            }, [
                h('n-icon', { 
                    style: { marginRight: '6px', fontSize: '12px' }
                }, [
                    h(getFileIcon(row.type))
                ]),
                h('span', { 
                    style: { 
                        overflow: 'hidden', 
                        textOverflow: 'ellipsis', 
                        whiteSpace: 'nowrap'
                    }
                }, row.name || 'Êú™Áü•Êñá‰ª∂')
            ])
        }
    },
    {
        title: 'Áä∂ÊÄÅ',
        key: 'status',
        width: 100,
        render: (row: any) => {
            console.log('Ê∏≤ÊüìÁä∂ÊÄÅ:', row.name, row.status)
            
            let statusText = '‚è≥ Á≠âÂæÖ'
            let statusColor = '#70c0e8'
            
            switch (row.status) {
                case 'completed':
                    statusText = '‚úÖ ÊàêÂäü'
                    statusColor = '#18a058'
                    break
                case 'failed':
                    statusText = '‚ùå Â§±Ë¥•'
                    statusColor = '#d03050'
                    break
                case 'downloading':
                    statusText = 'üîÑ ‰∏ãËΩΩ‰∏≠'
                    statusColor = '#f0a020'
                    break
                default:
                    statusText = '‚è≥ Á≠âÂæÖ'
                    statusColor = '#70c0e8'
            }
            
            return h('span', { 
                style: {
                    fontSize: '12px',
                    color: statusColor,
                    fontWeight: '500'
                }
            }, statusText)
        }
    }
]



// Ê†ºÂºèÂåñÂ≠óËäÇÂ§ßÂ∞è
const formatBytes = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes'
    const k = 1024
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

// ÊäìÂèñÈ°µÈù¢
const captureUrl = async () => {
    if (!form.value.url.trim()) {
        message.error('ËØ∑ËæìÂÖ•Ë¶ÅÊäìÂèñÁöÑ URL')
        return
    }

    // È¢ÑÂ§ÑÁêÜURL
    let processedUrl = form.value.url.trim()

    // Â¶ÇÊûúÊ≤°ÊúâÂçèËÆÆÔºåËá™Âä®Ê∑ªÂä†https://
    if (!processedUrl.startsWith('http://') && !processedUrl.startsWith('https://')) {
        processedUrl = 'https://' + processedUrl
        form.value.url = processedUrl
    }

    // È™åËØÅ URL Ê†ºÂºè
    try {
        const url = new URL(processedUrl)
        // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÊúâÊïàÁöÑÂüüÂêç
        if (!url.hostname || url.hostname.length < 3) {
            message.error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁΩëÁ´ôÂú∞ÂùÄ')
            return
        }
    } catch (error) {
        message.error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ URL Ê†ºÂºèÔºå‰æãÂ¶ÇÔºöhttps://example.com')
        return
    }

    // È™åËØÅ‰øùÂ≠òÁõÆÂΩï
    if (!saveDirectory.value.trim()) {
        message.error('ËØ∑ÂÖàÈÄâÊã©‰øùÂ≠òÁõÆÂΩï')
        return
    }

    // ÂºÄÂßãÂ§á‰ªΩÊµÅÁ®ã
    isCapturing.value = true
    captureResult.value = null
    
    // Êñá‰ª∂ÂàóË°®ÈªòËÆ§Â±ïÂºÄÔºåÊó†ÈúÄËÆæÁΩÆ
    
    // ÈáçÁΩÆËøõÂ∫¶Áä∂ÊÄÅ
    captureProgress.value = {
        phase: 'analyzing',
        totalFiles: 0,
        completedFiles: 0,
        currentFile: 'Ê≠£Âú®ÂàÜÊûêÈ°µÈù¢...',
        fileProgress: 0,
        downloadSpeed: '',
        estimatedTime: '',
        fileList: []
    }

    try {
        // ÂºÄÂßãËøõÂ∫¶ËΩÆËØ¢
        startProgressPolling()
        
        const result = await api('capture_page', {
            url: processedUrl,
            options: JSON.stringify(options.value)
        })

        if (result.code === 200) {
            captureProgress.value.phase = 'saving'
            captureProgress.value.currentFile = '‰øùÂ≠òÊñá‰ª∂‰∏≠...'
            
            // Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®‰∏∫ÁúüÂÆûÊï∞ÊçÆ
            if (result.data.fileDetails && result.data.fileDetails.length > 0) {
                captureProgress.value.fileList = result.data.fileDetails.map((file: any) => ({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    status: file.status,
                    progress: file.progress,
                    url: file.url
                }))
                captureProgress.value.totalFiles = result.data.fileDetails.length
                captureProgress.value.completedFiles = result.data.successCount || 0
            }
            
            captureResult.value = {
                success: true,
                url: processedUrl,
                timestamp: new Date().toLocaleString(),
                statusCode: result.data.statusCode || 200,
                contentType: result.data.contentType,
                contentLength: result.data.contentLength,
                duration: result.data.duration,
                filesCount: result.data.filesCount,
                zipPath: result.data.zipPath,
                zipSize: result.data.zipSize,
                downloadedFiles: result.data.downloadedFiles,
                successCount: result.data.successCount,
                failedCount: result.data.failedCount
            }

            // ‰øùÂ≠òZIPÊñá‰ª∂Âà∞ÊåáÂÆöÁõÆÂΩï
            if (result.data.zipPath) {
                if (saveDirectory.value) {
                    await saveZipToDirectory(result.data.zipPath)
                } else {
                    message.warning('Êú™ÈÄâÊã©‰øùÂ≠òÁõÆÂΩïÔºåZIPÊñá‰ª∂Â∑≤ÁîüÊàê‰ΩÜÊú™‰øùÂ≠ò')
                }
            }
            
            captureProgress.value.phase = 'complete'
            message.success(`Â§á‰ªΩÂÆåÊàêÔºÅÂÖ±Â§ÑÁêÜ ${result.data.filesCount} ‰∏™Êñá‰ª∂`)
        } else {
            captureResult.value = {
                success: false,
                url: form.value.url,
                timestamp: new Date().toLocaleString(),
                error: result.msg || 'ÊäìÂèñÂ§±Ë¥•',
                statusCode: result.data?.statusCode || 0
            }
            message.error(result.msg || 'È°µÈù¢Â§á‰ªΩÂ§±Ë¥•')
        }
    } catch (error) {
        console.error('Page capture error:', error)

        let errorMessage = 'Êú™Áü•ÈîôËØØ'
        if (error instanceof Error) {
            errorMessage = error.message
        } else if (typeof error === 'string') {
            errorMessage = error
        }

        captureResult.value = {
            success: false,
            url: form.value.url,
            timestamp: new Date().toLocaleString(),
            error: errorMessage
        }

        // Êèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
        if (errorMessage.includes('ÁΩëÁªú') || errorMessage.includes('network')) {
            message.error('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñURLÊòØÂê¶Ê≠£Á°Æ')
        } else if (errorMessage.includes('Ë∂ÖÊó∂') || errorMessage.includes('timeout')) {
            message.error('ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Â∞ùËØïÂ¢ûÂä†Ë∂ÖÊó∂Êó∂Èó¥ÊàñÁ®çÂêéÈáçËØï')
        } else if (errorMessage.includes('Ê†ºÂºè') || errorMessage.includes('format')) {
            message.error('URLÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑Ê£ÄÊü•ËæìÂÖ•ÁöÑÁΩëÂùÄ')
        } else if (errorMessage.includes('access denied') || errorMessage.includes('forbidden') || errorMessage.includes('ÂèçÁà¨Ëô´')) {
            message.error('ÁΩëÁ´ôÊãíÁªùËÆøÈóÆÔºåÂèØËÉΩÂ≠òÂú®ÂèçÁà¨Ëô´Êú∫Âà∂„ÄÇÂª∫ËÆÆÔºö1) Á®çÂêéÈáçËØï 2) Ê£ÄÊü•URLÊòØÂê¶ÈúÄË¶ÅÁôªÂΩï 3) Â∞ùËØïÂú®ÊµèËßàÂô®‰∏≠ÂÖàËÆøÈóÆËØ•È°µÈù¢')
        } else if (errorMessage.includes('ÈáçÂÆöÂêë') || errorMessage.includes('redirect')) {
            message.error('È°µÈù¢ÈáçÂÆöÂêëÊ¨°Êï∞ËøáÂ§öÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°Æ')
        } else if (errorMessage.includes('404') || errorMessage.includes('not found')) {
            message.error('È°µÈù¢‰∏çÂ≠òÂú®(404)ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°Æ')
        } else if (errorMessage.includes('500') || errorMessage.includes('server error')) {
            message.error('ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØ(500)ÔºåËØ∑Á®çÂêéÈáçËØï')
        } else if (errorMessage.includes('ÂìçÂ∫îÂÜÖÂÆπ‰∏∫Á©∫')) {
            message.error('È°µÈù¢ÂÜÖÂÆπ‰∏∫Á©∫ÔºåÂèØËÉΩÊòØÂä®ÊÄÅÂä†ËΩΩÁöÑÈ°µÈù¢ÊàñÈúÄË¶ÅJavaScriptÊ∏≤Êüì')
        } else {
            message.error('È°µÈù¢Â§á‰ªΩÂ§±Ë¥•Ôºö' + errorMessage)
        }
    } finally {
        isCapturing.value = false
        stopProgressPolling()
    }
}

// Ê∏ÖÁ©∫ÁªìÊûú
const clearResults = () => {
    captureResult.value = null
    message.info('Â∑≤Ê∏ÖÁ©∫Â§á‰ªΩÁªìÊûú')
}

// ‰øùÂ≠òZIPÊñá‰ª∂Âà∞ÊåáÂÆöÁõÆÂΩï
const saveZipToDirectory = async (zipPath: string) => {
    try {


        // ÁîüÊàêÊñá‰ª∂ÂêçÔºöÁΩëÁ´ôÂüüÂêç_Êó∂Èó¥Êà≥.zip
        const urlObj = new URL(captureResult.value.url)
        const domain = urlObj.hostname.replace(/[^a-zA-Z0-9]/g, '_')
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')
        const fileName = `${domain}_${timestamp}.zip`

        // Ë∞ÉÁî®GoÂêéÁ´ØÁöÑÊñá‰ª∂‰øùÂ≠òÊñπÊ≥ï
        const response = await api('save_zip_to_directory', {
            sourcePath: zipPath,
            targetDirectory: saveDirectory.value,
            fileName: fileName
        })



        if (response && response.code === 200) {
            message.success(`ZIPÊñá‰ª∂Â∑≤‰øùÂ≠òÂà∞: ${saveDirectory.value}\\${fileName}`)
        } else {
            message.error('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (response?.msg || 'Êú™Áü•ÈîôËØØ'))
        }
    } catch (error) {
        console.error('Save zip error:', error)
        message.error('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (error as Error).message)
    }
}

// Ëá™Âä®‰∏ãËΩΩZIPÊñá‰ª∂Ôºà‰øùÁïô‰Ωú‰∏∫Â§áÁî®Ôºâ
const autoDownloadZip = async (zipPath: string) => {
    try {


        // Ë∞ÉÁî®GoÂêéÁ´ØÁöÑÊñá‰ª∂‰∏ãËΩΩÊñπÊ≥ï
        const response = await api('download_file', {
            filePath: zipPath
        })



        if (response && response.code === 200 && response.data) {
            // Â§ÑÁêÜBase64ÁºñÁ†ÅÁöÑ‰∫åËøõÂà∂Êï∞ÊçÆ
            let binaryData
            if (typeof response.data === 'string') {
                // ÂêéÁ´ØËøîÂõûBase64ÁºñÁ†ÅÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•Ëß£Á†Å
                try {
                    const binaryString = atob(response.data)
                    binaryData = new Uint8Array(binaryString.length)
                    for (let i = 0; i < binaryString.length; i++) {
                        binaryData[i] = binaryString.charCodeAt(i)
                    }

                } catch (e) {
                    console.error('Base64Ëß£Á†ÅÂ§±Ë¥•:', e)
                    throw new Error('Base64Ëß£Á†ÅÂ§±Ë¥•: ' + (e as Error).message)
                }
            } else if (Array.isArray(response.data)) {
                // ÂÖºÂÆπÊóßÁöÑÊï∞ÁªÑÊ†ºÂºè
                binaryData = new Uint8Array(response.data)
            } else {
                throw new Error('‰∏çÊîØÊåÅÁöÑÊï∞ÊçÆÊ†ºÂºè: ' + typeof response.data)
            }

            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const blob = new Blob([binaryData], { type: 'application/zip' })
            const url = window.URL.createObjectURL(blob)
            const link = document.createElement('a')
            link.href = url

            // ÁîüÊàêÊñá‰ª∂ÂêçÔºöÁΩëÁ´ôÂüüÂêç_Êó∂Èó¥Êà≥.zip
            const urlObj = new URL(captureResult.value.url)
            const domain = urlObj.hostname.replace(/[^a-zA-Z0-9]/g, '_')
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')
            link.download = `${domain}_${timestamp}.zip`

            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
            window.URL.revokeObjectURL(url)



            message.success(`ZIPÊñá‰ª∂Â∑≤‰∏ãËΩΩ: ${link.download}`)
        } else {
            message.error('‰∏ãËΩΩÂ§±Ë¥•Ôºö' + (response?.msg || 'ÊúçÂä°Âô®ËøîÂõûÊï∞ÊçÆ‰∏∫Á©∫'))
        }
    } catch (error) {
        console.error('Auto download error:', error)
        message.error('Ëá™Âä®‰∏ãËΩΩÂ§±Ë¥•Ôºö' + (error as Error).message)
    }
}



// ÈÄâÊã©‰øùÂ≠òÁõÆÂΩï
const selectDirectory = async () => {
    try {
        // Ë∞ÉÁî®GoÂêéÁ´ØÁöÑÁõÆÂΩïÈÄâÊã©ÊñπÊ≥ï
        const result = await api('select_directory', {})

        if (result && result.code === 200 && result.data) {
            saveDirectory.value = result.data
            // ÁºìÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem('pageCapture_saveDirectory', result.data)
            message.success('ÁõÆÂΩïÈÄâÊã©ÊàêÂäü')
        } else if (result && result.code === 400) {
            // Áî®Êà∑ÂèñÊ∂àÈÄâÊã©
            message.info('Â∑≤ÂèñÊ∂àÈÄâÊã©ÁõÆÂΩï')
        } else {
            message.error('ÈÄâÊã©ÁõÆÂΩïÂ§±Ë¥•Ôºö' + (result?.msg || 'Êú™Áü•ÈîôËØØ'))
        }
    } catch (error) {
        console.error('Select directory error:', error)
        message.error('ÈÄâÊã©ÁõÆÂΩïÂºÇÂ∏∏Ôºö' + (error as Error).message)
    }
}

// ÊµãËØïËøûÊé•
const testConnection = async () => {
    if (!form.value.url.trim()) {
        message.error('ËØ∑ÂÖàËæìÂÖ•URL')
        return
    }

    let testUrl = form.value.url.trim()
    if (!testUrl.startsWith('http://') && !testUrl.startsWith('https://')) {
        testUrl = 'https://' + testUrl
    }

    try {
        const url = new URL(testUrl)
        message.info(`Ê≠£Âú®ÊµãËØïËøûÊé•Âà∞: ${url.hostname}`)

        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑËøûÊé•ÊµãËØï
        // ÊöÇÊó∂Âè™ÊòæÁ§∫URLËß£ÊûêÁªìÊûú
        message.success(`URLËß£ÊûêÊàêÂäü: ${url.protocol}//${url.hostname}${url.pathname}`)
    } catch (error) {
        message.error('URLÊ†ºÂºèÈîôËØØ: ' + (error as Error).message)
    }
}

// Ê†ºÂºèÂåñÊñá‰ª∂Ë∑ØÂæÑÊòæÁ§∫
const formatFilePath = (filePath: string): string => {
    // Â¶ÇÊûúÊòØindex.htmlÔºåÊòæÁ§∫‰∏∫Ê†πÊñá‰ª∂
    if (filePath === 'index.html') {
        return 'üìÑ ' + filePath
    }
    // Â¶ÇÊûúÂú®staticÁõÆÂΩï‰∏ãÔºåÊ∑ªÂä†Êñá‰ª∂Â§πÂõæÊ†á
    if (filePath.startsWith('static/')) {
        const parts = filePath.split('/')
        if (parts.length >= 3) {
            const folder = parts[1]
            const file = parts[2]
            const folderIcon = folder === 'css' ? 'üé®' : folder === 'js' ? '‚ö°' : folder === 'images' ? 'üñºÔ∏è' : 'üìÅ'
            return `${folderIcon} static/${folder}/${file}`
        }
    }
    return 'üìÑ ' + filePath
}

// ÊòæÁ§∫ÂäüËÉΩËØ¥ÊòéÊñáÊ°£
const showDocumentation = () => {
    documentationContent.value = `
        <h2>üõ°Ô∏è È°µÈù¢ÊçïËé∑ÈöêÁßÅÊ∏ÖÁêÜÂäüËÉΩ</h2>
        
        <h3>ÂäüËÉΩÊ¶ÇËø∞</h3>
        <p>Âú®È°µÈù¢Â§á‰ªΩÂ∑•ÂÖ∑‰∏≠Êñ∞Â¢û‰∫ÜÈöêÁßÅÊ∏ÖÁêÜÂäüËÉΩÔºåÂèØ‰ª•Ëá™Âä®Âà†Èô§ÁΩëÈ°µ‰∏≠ÁöÑÁ¨¨‰∏âÊñπË∑üË∏™„ÄÅÁªüËÆ°„ÄÅÂπøÂëä‰ª£Á†ÅÔºå‰øùÊä§Áî®Êà∑ÈöêÁßÅ„ÄÇ</p>
        
        <h3>ÈöêÁßÅÊ∏ÖÁêÜÈÄâÈ°π</h3>
        
        <h4>1. Âà†Èô§ÁªüËÆ°ÂàÜÊûê‰ª£Á†Å ‚úÖ</h4>
        <ul>
            <li>Google Analytics / gtag.js / GA4</li>
            <li>ÁôæÂ∫¶ÁªüËÆ° / CNZZ</li>
            <li>Mixpanel / Segment</li>
        </ul>
        
        <h4>2. Âà†Èô§Ë∑üË∏™‰ª£Á†Å ‚úÖ</h4>
        <ul>
            <li>Facebook Pixel</li>
            <li>TikTok Pixel / Snapchat Pixel</li>
            <li>Hotjar / CrazyEgg / Clarity</li>
        </ul>
        
        <h4>3. Âà†Èô§ÂπøÂëä‰ª£Á†Å ‚úÖ</h4>
        <ul>
            <li>Google Ads / DoubleClick</li>
            <li>Taboola / Outbrain</li>
            <li>PopAds / PropellerAds / AdCash</li>
            <li>affiliate.js / redirect.js</li>
        </ul>
        
        <h4>4. Âà†Èô§Ê†áÁ≠æÁÆ°ÁêÜÂô® ‚úÖ</h4>
        <ul>
            <li>Google Tag Manager (GTM)</li>
        </ul>
        
        <h4>5. Âà†Èô§ÊÅ∂ÊÑèÊ†áÁ≠æ ‚úÖ</h4>
        <ul>
            <li><code>&lt;base href="..."&gt;</code> - Èò≤Ê≠¢Âä´ÊåÅÊâÄÊúâÁõ∏ÂØπÈìæÊé•</li>
            <li><code>&lt;meta http-equiv="refresh"&gt;</code> - Èò≤Ê≠¢Ëá™Âä®Ë∑≥ËΩ¨Âà∞ÊÅ∂ÊÑèÁΩëÁ´ô</li>
            <li><code>&lt;meta name="referrer"&gt;</code> - Èò≤Ê≠¢Êù•Ê∫ê‰º™ÈÄ†</li>
            <li>ÊÅ∂ÊÑèJavaScriptÈáçÂÆöÂêë‰ª£Á†Å</li>
        </ul>
        
        <h3>ÂÆâÂÖ®Èò≤Êä§</h3>
        
        <h4>ÊÅ∂ÊÑèÊ†áÁ≠æÈò≤Êä§</h4>
        <ol>
            <li><strong>&lt;base&gt; Ê†áÁ≠æÂä´ÊåÅÈò≤Êä§</strong> - Ëá™Âä®Âà†Èô§ÊâÄÊúâ base Ê†áÁ≠æÔºåÈò≤Ê≠¢ÊÅ∂ÊÑèÁΩëÁ´ôÂä´ÊåÅÈ°µÈù¢‰∏≠ÁöÑÊâÄÊúâÁõ∏ÂØπÈìæÊé•</li>
            <li><strong>Ëá™Âä®Ë∑≥ËΩ¨Èò≤Êä§</strong> - Âà†Èô§ meta refresh Ê†áÁ≠æÔºåÈò≤Ê≠¢È°µÈù¢Ëá™Âä®Ë∑≥ËΩ¨Âà∞ÈíìÈ±ºÁΩëÁ´ôÊàñÊÅ∂ÊÑèÁΩëÁ´ô</li>
            <li><strong>Êù•Ê∫ê‰º™ÈÄ†Èò≤Êä§</strong> - Âà†Èô§ meta referrer Ê†áÁ≠æÔºåÈò≤Ê≠¢ÊÅ∂ÊÑèÁΩëÁ´ô‰º™ÈÄ†ËÆøÈóÆÊù•Ê∫ê</li>
            <li><strong>JavaScriptÈáçÂÆöÂêëÈò≤Êä§</strong> - Ê£ÄÊµãÂπ∂Âà†Èô§ÂåÖÂê´ÊÅ∂ÊÑèÈáçÂÆöÂêëÁöÑJavaScript‰ª£Á†Å</li>
        </ol>
        
        <h3>‰ΩøÁî®ÊñπÊ≥ï</h3>
        <ol>
            <li>Âú®È°µÈù¢ÊçïËé∑ÁïåÈù¢‰∏≠ÔºåÊâæÂà∞"ÈöêÁßÅÊ∏ÖÁêÜ"ÈÄâÈ°πÁªÑ</li>
            <li>Ê†πÊçÆÈúÄË¶ÅÂãæÈÄâË¶ÅÂà†Èô§ÁöÑÁ¨¨‰∏âÊñπ‰ª£Á†ÅÁ±ªÂûã</li>
            <li>ÂºÄÂßãÂ§á‰ªΩÔºåÁ≥ªÁªü‰ºöËá™Âä®Ê∏ÖÁêÜÈÄâ‰∏≠ÁöÑ‰ª£Á†ÅÁ±ªÂûã</li>
            <li>Â§á‰ªΩÂÆåÊàêÂêéÔºåÁîüÊàêÁöÑHTMLÊñá‰ª∂Â∞Ü‰∏çÂåÖÂê´Ë¢´Ê∏ÖÁêÜÁöÑÁ¨¨‰∏âÊñπ‰ª£Á†Å</li>
        </ol>
        
        <h3>Ê≥®ÊÑè‰∫ãÈ°π</h3>
        <ul>
            <li>ÈöêÁßÅÊ∏ÖÁêÜÂäüËÉΩÈªòËÆ§ÂêØÁî®ÔºåÁ°Æ‰øùÁî®Êà∑ÈöêÁßÅÂÆâÂÖ®</li>
            <li>ÊÅ∂ÊÑèÊ†áÁ≠æÊ∏ÖÁêÜÂäüËÉΩÈªòËÆ§ÂêØÁî®ÔºåÊèê‰æõÈ¢ùÂ§ñÁöÑÂÆâÂÖ®Èò≤Êä§</li>
            <li>Ê∏ÖÁêÜËøáÁ®ã‰∏ç‰ºöÂΩ±ÂìçÈ°µÈù¢ÁöÑÂü∫Êú¨ÂäüËÉΩÂíåÊ†∑Âºè</li>
            <li>Ë¢´Ê∏ÖÁêÜÁöÑ‰ª£Á†ÅÂåÖÊã¨Â§ñÈÉ®ÂºïÁî®ÂíåÂÜÖËÅî‰ª£Á†Å</li>
            <li>Ê∏ÖÁêÜÂêéÁöÑÈ°µÈù¢Âú®Á¶ªÁ∫øÁéØÂ¢É‰∏ãÊµèËßàÊõ¥Âä†ÂÆâÂÖ®</li>
        </ul>
    `
    showDocModal.value = true
}

// ÊòæÁ§∫ÊµãËØïÈ°µÈù¢‰ª£Á†Å
const showTestPage = () => {
    testPageContent.value = 'HTMLÊµãËØïÈ°µÈù¢ÂåÖÂê´‰ª•‰∏ãÂÜÖÂÆπÔºö\n\n' +
        '1. ÊÅ∂ÊÑèÊ†áÁ≠æÁ§∫‰æãÔºö\n' +
        '   - <base href="https://evil-site.com/">\n' +
        '   - <meta http-equiv="refresh" content="5;url=https://phishing-site.com">\n' +
        '   - <meta name="referrer" content="no-referrer">\n\n' +
        '2. Á¨¨‰∏âÊñπË∑üË∏™‰ª£Á†ÅÔºö\n' +
        '   - Google Analytics\n' +
        '   - Facebook Pixel\n' +
        '   - ÁôæÂ∫¶ÁªüËÆ°\n' +
        '   - Google Tag Manager\n\n' +
        '3. ÊÅ∂ÊÑèJavaScript‰ª£Á†ÅÔºö\n' +
        '   - window.location.href ÈáçÂÆöÂêë\n' +
        '   - setTimeout Âª∂Êó∂Ë∑≥ËΩ¨\n' +
        '   - Âä®ÊÄÅÂàõÂª∫baseÊ†áÁ≠æ\n\n' +
        'Ëøô‰∫õ‰ª£Á†ÅÂú®ÂêØÁî®ÈöêÁßÅÊ∏ÖÁêÜÂäüËÉΩÂêé‰ºöË¢´Ëá™Âä®Âà†Èô§„ÄÇ'
    
    showTestModal.value = true
}

// ËøõÂ∫¶ËΩÆËØ¢ÂèòÈáè
let progressPollingInterval: NodeJS.Timeout | null = null

// Ê∑ªÂä†Ëé∑ÂèñËøõÂ∫¶ÁöÑAPI
const getProgress = async () => {
    try {
        const result = await api('get_capture_progress', {})
        if (result && result.code === 200 && result.data) {
            const data = result.data
            console.log('ËΩÆËØ¢Ëé∑ÂèñËøõÂ∫¶:', data)
            
            // Êõ¥Êñ∞ËøõÂ∫¶Áä∂ÊÄÅ
            captureProgress.value = {
                phase: data.phase || captureProgress.value.phase,
                totalFiles: data.totalFiles || captureProgress.value.totalFiles,
                completedFiles: data.completedFiles || captureProgress.value.completedFiles,
                currentFile: data.currentFile || captureProgress.value.currentFile,
                fileProgress: data.fileProgress || captureProgress.value.fileProgress,
                downloadSpeed: data.downloadSpeed || captureProgress.value.downloadSpeed,
                estimatedTime: data.estimatedTime || captureProgress.value.estimatedTime,
                fileList: data.fileList || captureProgress.value.fileList
            }
        }
    } catch (error) {
        // ÈùôÈªòÂ§ÑÁêÜÈîôËØØÔºåÈÅøÂÖçÂπ≤Êâ∞Áî®Êà∑‰ΩìÈ™å
        console.log('Ëé∑ÂèñËøõÂ∫¶Â§±Ë¥•:', error)
    }
}

// ÂºÄÂßãËøõÂ∫¶ËΩÆËØ¢
const startProgressPolling = () => {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval)
    }
    
    progressPollingInterval = setInterval(async () => {
        if (isCapturing.value) {
            await getProgress()
        } else {
            stopProgressPolling()
        }
    }, 500) // ÊØè500msËΩÆËØ¢‰∏ÄÊ¨°
}

// ÂÅúÊ≠¢ËøõÂ∫¶ËΩÆËØ¢
const stopProgressPolling = () => {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval)
        progressPollingInterval = null
    }
}

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËΩÆËØ¢
onUnmounted(() => {
    stopProgressPolling()
})


</script>

<style scoped>
:deep(.n-card .n-card__header) {
    padding-bottom: 12px;
}

:deep(.n-descriptions .n-descriptions-item) {
    padding: 6px 0;
}

:deep(.n-form-item) {
    margin-bottom: 16px;
}

.documentation-content {
    line-height: 1.6;
    font-size: 14px;
}

.documentation-content h2 {
    color: #2080f0;
    border-bottom: 2px solid #2080f0;
    padding-bottom: 8px;
    margin-bottom: 16px;
}

.documentation-content h3 {
    color: #18a058;
    margin-top: 24px;
    margin-bottom: 12px;
}

.documentation-content h4 {
    color: #f0a020;
    margin-top: 16px;
    margin-bottom: 8px;
}

.documentation-content ul, .documentation-content ol {
    margin-left: 20px;
    margin-bottom: 12px;
}

.documentation-content li {
    margin-bottom: 4px;
}

.documentation-content code {
    background-color: #f5f5f5;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #d03050;
}

/* ËøõÂ∫¶Âç°ÁâáÊ†∑Âºè */
.progress-card {
    border: 1px solid #e0e7ff !important;
    background: linear-gradient(135deg, #f8faff 0%, #f1f5ff 100%) !important;
}

.overall-progress {
    padding: 16px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.phase-text {
    font-weight: 600;
    color: #1f2937;
    font-size: 16px;
}

.progress-stats {
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    font-size: 12px;
    color: #6b7280;
}

.current-file {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.download-speed {
    color: #059669;
    font-weight: 500;
}

/* È°µÈù¢Â∏ÉÂ±ÄÊ†∑Âºè */
.page-capture-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.header-card {
    margin-bottom: 20px;
}

.header-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.header-title {
    font-size: 20px;
    font-weight: 600;
    color: #1f2937;
}

.main-content {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 20px;
    min-height: 600px;
}

.config-section {
    display: flex;
    flex-direction: column;
}

.progress-section {
    display: flex;
    flex-direction: column;
}

.action-buttons {
    margin-top: 16px;
}

.status-card {
    height: fit-content;
}

.status-card.empty {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
}

.empty-state {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.overall-progress {
    padding: 16px;
    background: #f8faff;
    border-radius: 8px;
    border: 1px solid #e0e7ff;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.progress-label {
    font-weight: 600;
    color: #1f2937;
}

.progress-count {
    color: #6b7280;
    font-size: 14px;
}

.file-statistics {
    margin-top: 16px;
}

/* ÁÆÄÂåñÁöÑÊñá‰ª∂ÂàóË°®Ê†∑Âºè */
.file-list-section {
    margin-top: 0;
}

.file-name-cell {
    display: flex;
    align-items: center;
    min-width: 0;
}

.file-name-text {
    font-weight: 500;
    color: #1f2937;
    font-size: 13px;
}

.url-text {
    display: block;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: help;
}

.file-icon-small {
    color: #6b7280;
}

.file-size-text {
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}

.status-cell {
    display: flex;
    align-items: center;
}

.status-text {
    font-size: 12px;
    font-weight: 500;
}

.progress-cell {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.progress-percentage {
    text-align: center;
}

.progress-text {
    font-size: 12px;
    font-weight: 500;
    color: #f59e0b;
}

/* ÁªìÊûúÊñá‰ª∂ÂàóË°®Ê†∑Âºè */
.result-file-list {
    margin-top: 16px;
}

.result-file-list .file-items {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
}

.status-text {
    font-size: 12px;
    font-weight: 500;
}

.status-text.success {
    color: #10b981;
}

.status-text.error {
    color: #ef4444;
}

.status-text.pending {
    color: #6b7280;
}

.file-statistics {
    margin-top: 16px;
}
</style>